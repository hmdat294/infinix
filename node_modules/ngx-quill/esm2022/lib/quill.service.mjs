import { DOCUMENT } from '@angular/common';
import { inject, Injectable } from '@angular/core';
import { defer, firstValueFrom, forkJoin, from, isObservable, of } from 'rxjs';
import { map, shareReplay, tap } from 'rxjs/operators';
import { defaultModules, QUILL_CONFIG_TOKEN } from 'ngx-quill/config';
import * as i0 from "@angular/core";
export class QuillService {
    constructor() {
        this.config = inject(QUILL_CONFIG_TOKEN) || { modules: defaultModules };
        this.document = inject(DOCUMENT);
        this.quill$ = defer(async () => {
            if (!this.Quill) {
                // Quill adds events listeners on import https://github.com/quilljs/quill/blob/develop/core/emitter.js#L8
                // We'd want to use the unpatched `addEventListener` method to have all event callbacks to be run outside of zone.
                // We don't know yet if the `zone.js` is used or not, just save the value to restore it back further.
                const maybePatchedAddEventListener = this.document.addEventListener;
                // There're 2 types of Angular applications:
                // 1) zone-full (by default)
                // 2) zone-less
                // The developer can avoid importing the `zone.js` package and tells Angular that he/she is responsible for running
                // the change detection by himself. This is done by "nooping" the zone through `CompilerOptions` when bootstrapping
                // the root module. We fallback to `document.addEventListener` if `__zone_symbol__addEventListener` is not defined,
                // this means the `zone.js` is not imported.
                // The `__zone_symbol__addEventListener` is basically a native DOM API, which is not patched by zone.js, thus not even going
                // through the `zone.js` task lifecycle. You can also access the native DOM API as follows `target[Zone.__symbol__('methodName')]`.
                this.document.addEventListener =
                    this.document['__zone_symbol__addEventListener'] ||
                        this.document.addEventListener;
                const quillImport = await import('quill');
                this.document.addEventListener = maybePatchedAddEventListener;
                this.Quill = (
                // seems like esmodules have nested "default"
                quillImport.default?.default ?? quillImport.default ?? quillImport);
            }
            // Only register custom options and modules once
            this.config.customOptions?.forEach((customOption) => {
                const newCustomOption = this.Quill.import(customOption.import);
                newCustomOption.whitelist = customOption.whitelist;
                this.Quill.register(newCustomOption, true, this.config.suppressGlobalRegisterWarning);
            });
            return firstValueFrom(this.registerCustomModules(this.Quill, this.config.customModules, this.config.suppressGlobalRegisterWarning));
        }).pipe(shareReplay({
            bufferSize: 1,
            refCount: false
        }));
        // A list of custom modules that have already been registered,
        // so we don’t need to await their implementation.
        this.registeredModules = new Set();
    }
    getQuill() {
        return this.quill$;
    }
    /** @internal */
    beforeRender(Quill, customModules, beforeRender = this.config.beforeRender) {
        // This function is called each time the editor needs to be rendered,
        // so it operates individually per component. If no custom module needs to be
        // registered and no `beforeRender` function is provided, it will emit
        // immediately and proceed with the rendering.
        const sources = [this.registerCustomModules(Quill, customModules)];
        if (beforeRender) {
            sources.push(from(beforeRender()));
        }
        return forkJoin(sources).pipe(map(() => Quill));
    }
    /** @internal */
    registerCustomModules(Quill, customModules, suppressGlobalRegisterWarning) {
        if (!Array.isArray(customModules)) {
            return of(Quill);
        }
        const sources = [];
        for (const customModule of customModules) {
            const { path, implementation: maybeImplementation } = customModule;
            // If the module is already registered, proceed to the next module...
            if (this.registeredModules.has(path)) {
                continue;
            }
            this.registeredModules.add(path);
            if (isObservable(maybeImplementation)) {
                // If the implementation is an observable, we will wait for it to load and
                // then register it with Quill. The caller will wait until the module is registered.
                sources.push(maybeImplementation.pipe(tap((implementation) => {
                    Quill.register(path, implementation, suppressGlobalRegisterWarning);
                })));
            }
            else {
                Quill.register(path, maybeImplementation, suppressGlobalRegisterWarning);
            }
        }
        return sources.length > 0 ? forkJoin(sources).pipe(map(() => Quill)) : of(Quill);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.10", ngImport: i0, type: QuillService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.10", ngImport: i0, type: QuillService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.10", ngImport: i0, type: QuillService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVpbGwuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1xdWlsbC9zcmMvbGliL3F1aWxsLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFBO0FBQzFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFBO0FBQ2xELE9BQU8sRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQTtBQUMxRixPQUFPLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQTtBQUV0RCxPQUFPLEVBRUwsY0FBYyxFQUNkLGtCQUFrQixFQUVuQixNQUFNLGtCQUFrQixDQUFBOztBQUt6QixNQUFNLE9BQU8sWUFBWTtJQUh6QjtRQUlXLFdBQU0sR0FBRyxNQUFNLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBQyxjQUFjLEVBQWlCLENBQUE7UUFFakYsYUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUkzQixXQUFNLEdBQW9CLEtBQUssQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNqRCxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNoQix5R0FBeUc7Z0JBQ3pHLGtIQUFrSDtnQkFDbEgscUdBQXFHO2dCQUNyRyxNQUFNLDRCQUE0QixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUE7Z0JBQ25FLDRDQUE0QztnQkFDNUMsNEJBQTRCO2dCQUM1QixlQUFlO2dCQUNmLG1IQUFtSDtnQkFDbkgsbUhBQW1IO2dCQUNuSCxtSEFBbUg7Z0JBQ25ILDRDQUE0QztnQkFDNUMsNEhBQTRIO2dCQUM1SCxtSUFBbUk7Z0JB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QkFDckMsU0FBUTtZQUNWLENBQUM7WUFFRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBRWhDLElBQUksWUFBWSxDQUFDLG1CQUFtQixDQUFDLEVBQUUsQ0FBQztnQkFDdEMsMEVBQTBFO2dCQUMxRSxvRkFBb0Y7Z0JBQ3BGLE9BQU8sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUNuQyxHQUFHLENBQUMsQ0FBQyxjQUFjLEVBQUUsRUFBRTtvQkFDckIsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFLDZCQUE2QixDQUFDLENBQUE7Z0JBQ3JFLENBQUMsQ0FBQyxDQUNILENBQUMsQ0FBQTtZQUNKLENBQUM7aUJBQU0sQ0FBQztnQkFDTixLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxtQkFBbUIsRUFBRSw2QkFBNkIsQ0FBQyxDQUFBO1lBQzFFLENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQ2xGLENBQUM7K0dBbEhVLFlBQVk7bUhBQVosWUFBWSxjQUZYLE1BQU07OzRGQUVQLFlBQVk7a0JBSHhCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nXG5pbXBvcnQgeyBpbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJ1xuaW1wb3J0IHsgZGVmZXIsIGZpcnN0VmFsdWVGcm9tLCBmb3JrSm9pbiwgZnJvbSwgaXNPYnNlcnZhYmxlLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnXG5pbXBvcnQgeyBtYXAsIHNoYXJlUmVwbGF5LCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycydcblxuaW1wb3J0IHtcbiAgQ3VzdG9tTW9kdWxlLFxuICBkZWZhdWx0TW9kdWxlcyxcbiAgUVVJTExfQ09ORklHX1RPS0VOLFxuICBRdWlsbENvbmZpZ1xufSBmcm9tICduZ3gtcXVpbGwvY29uZmlnJ1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgUXVpbGxTZXJ2aWNlIHtcbiAgcmVhZG9ubHkgY29uZmlnID0gaW5qZWN0KFFVSUxMX0NPTkZJR19UT0tFTikgfHwgeyBtb2R1bGVzOmRlZmF1bHRNb2R1bGVzIH0gYXMgUXVpbGxDb25maWdcblxuICBwcml2YXRlIGRvY3VtZW50ID0gaW5qZWN0KERPQ1VNRU5UKVxuXG4gIHByaXZhdGUgUXVpbGwhOiBhbnlcblxuICBwcml2YXRlIHF1aWxsJDogT2JzZXJ2YWJsZTxhbnk+ID0gZGVmZXIoYXN5bmMgKCkgPT4ge1xuICAgIGlmICghdGhpcy5RdWlsbCkge1xuICAgICAgLy8gUXVpbGwgYWRkcyBldmVudHMgbGlzdGVuZXJzIG9uIGltcG9ydCBodHRwczovL2dpdGh1Yi5jb20vcXVpbGxqcy9xdWlsbC9ibG9iL2RldmVsb3AvY29yZS9lbWl0dGVyLmpzI0w4XG4gICAgICAvLyBXZSdkIHdhbnQgdG8gdXNlIHRoZSB1bnBhdGNoZWQgYGFkZEV2ZW50TGlzdGVuZXJgIG1ldGhvZCB0byBoYXZlIGFsbCBldmVudCBjYWxsYmFja3MgdG8gYmUgcnVuIG91dHNpZGUgb2Ygem9uZS5cbiAgICAgIC8vIFdlIGRvbid0IGtub3cgeWV0IGlmIHRoZSBgem9uZS5qc2AgaXMgdXNlZCBvciBub3QsIGp1c3Qgc2F2ZSB0aGUgdmFsdWUgdG8gcmVzdG9yZSBpdCBiYWNrIGZ1cnRoZXIuXG4gICAgICBjb25zdCBtYXliZVBhdGNoZWRBZGRFdmVudExpc3RlbmVyID0gdGhpcy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyXG4gICAgICAvLyBUaGVyZSdyZSAyIHR5cGVzIG9mIEFuZ3VsYXIgYXBwbGljYXRpb25zOlxuICAgICAgLy8gMSkgem9uZS1mdWxsIChieSBkZWZhdWx0KVxuICAgICAgLy8gMikgem9uZS1sZXNzXG4gICAgICAvLyBUaGUgZGV2ZWxvcGVyIGNhbiBhdm9pZCBpbXBvcnRpbmcgdGhlIGB6b25lLmpzYCBwYWNrYWdlIGFuZCB0ZWxscyBBbmd1bGFyIHRoYXQgaGUvc2hlIGlzIHJlc3BvbnNpYmxlIGZvciBydW5uaW5nXG4gICAgICAvLyB0aGUgY2hhbmdlIGRldGVjdGlvbiBieSBoaW1zZWxmLiBUaGlzIGlzIGRvbmUgYnkgXCJub29waW5nXCIgdGhlIHpvbmUgdGhyb3VnaCBgQ29tcGlsZXJPcHRpb25zYCB3aGVuIGJvb3RzdHJhcHBpbmdcbiAgICAgIC8vIHRoZSByb290IG1vZHVsZS4gV2UgZmFsbGJhY2sgdG8gYGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXJgIGlmIGBfX3pvbmVfc3ltYm9sX19hZGRFdmVudExpc3RlbmVyYCBpcyBub3QgZGVmaW5lZCxcbiAgICAgIC8vIHRoaXMgbWVhbnMgdGhlIGB6b25lLmpzYCBpcyBub3QgaW1wb3J0ZWQuXG4gICAgICAvLyBUaGUgYF9fem9uZV9zeW1ib2xfX2FkZEV2ZW50TGlzdGVuZXJgIGlzIGJhc2ljYWxseSBhIG5hdGl2ZSBET00gQVBJLCB3aGljaCBpcyBub3QgcGF0Y2hlZCBieSB6b25lLmpzLCB0aHVzIG5vdCBldmVuIGdvaW5nXG4gICAgICAvLyB0aHJvdWdoIHRoZSBgem9uZS5qc2AgdGFzayBsaWZlY3ljbGUuIFlvdSBjYW4gYWxzbyBhY2Nlc3MgdGhlIG5hdGl2ZSBET00gQVBJIGFzIGZvbGxvd3MgYHRhcmdldFtab25lLl9fc3ltYm9sX18oJ21ldGhvZE5hbWUnKV1gLlxuICAgICAgdGhpcy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyID1cbiAgICAgICAgdGhpcy5kb2N1bWVudFsnX196b25lX3N5bWJvbF9fYWRkRXZlbnRMaXN0ZW5lciddIHx8XG4gICAgICAgIHRoaXMuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lclxuICAgICAgY29uc3QgcXVpbGxJbXBvcnQgPSBhd2FpdCBpbXBvcnQoJ3F1aWxsJylcbiAgICAgIHRoaXMuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciA9IG1heWJlUGF0Y2hlZEFkZEV2ZW50TGlzdGVuZXJcblxuICAgICAgdGhpcy5RdWlsbCA9IChcbiAgICAgICAgLy8gc2VlbXMgbGlrZSBlc21vZHVsZXMgaGF2ZSBuZXN0ZWQgXCJkZWZhdWx0XCJcbiAgICAgICAgKHF1aWxsSW1wb3J0LmRlZmF1bHQgYXMgYW55KT8uZGVmYXVsdCA/PyBxdWlsbEltcG9ydC5kZWZhdWx0ID8/IHF1aWxsSW1wb3J0XG4gICAgICApIGFzIGFueVxuICAgIH1cblxuICAgIC8vIE9ubHkgcmVnaXN0ZXIgY3VzdG9tIG9wdGlvbnMgYW5kIG1vZHVsZXMgb25jZVxuICAgIHRoaXMuY29uZmlnLmN1c3RvbU9wdGlvbnM/LmZvckVhY2goKGN1c3RvbU9wdGlvbikgPT4ge1xuICAgICAgY29uc3QgbmV3Q3VzdG9tT3B0aW9uID0gdGhpcy5RdWlsbC5pbXBvcnQoY3VzdG9tT3B0aW9uLmltcG9ydClcbiAgICAgIG5ld0N1c3RvbU9wdGlvbi53aGl0ZWxpc3QgPSBjdXN0b21PcHRpb24ud2hpdGVsaXN0XG4gICAgICB0aGlzLlF1aWxsLnJlZ2lzdGVyKFxuICAgICAgICBuZXdDdXN0b21PcHRpb24sXG4gICAgICAgIHRydWUsXG4gICAgICAgIHRoaXMuY29uZmlnLnN1cHByZXNzR2xvYmFsUmVnaXN0ZXJXYXJuaW5nXG4gICAgICApXG4gICAgfSlcblxuICAgIHJldHVybiBmaXJzdFZhbHVlRnJvbSh0aGlzLnJlZ2lzdGVyQ3VzdG9tTW9kdWxlcyhcbiAgICAgIHRoaXMuUXVpbGwsXG4gICAgICB0aGlzLmNvbmZpZy5jdXN0b21Nb2R1bGVzLFxuICAgICAgdGhpcy5jb25maWcuc3VwcHJlc3NHbG9iYWxSZWdpc3Rlcldhcm5pbmdcbiAgICApKVxuICB9KS5waXBlKFxuICAgIHNoYXJlUmVwbGF5KHtcbiAgICAgIGJ1ZmZlclNpemU6IDEsXG4gICAgICByZWZDb3VudDogZmFsc2VcbiAgICB9KVxuICApXG5cbiAgLy8gQSBsaXN0IG9mIGN1c3RvbSBtb2R1bGVzIHRoYXQgaGF2ZSBhbHJlYWR5IGJlZW4gcmVnaXN0ZXJlZCxcbiAgLy8gc28gd2UgZG9u4oCZdCBuZWVkIHRvIGF3YWl0IHRoZWlyIGltcGxlbWVudGF0aW9uLlxuICBwcml2YXRlIHJlZ2lzdGVyZWRNb2R1bGVzID0gbmV3IFNldDxzdHJpbmc+KClcblxuICBnZXRRdWlsbCgpIHtcbiAgICByZXR1cm4gdGhpcy5xdWlsbCRcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgYmVmb3JlUmVuZGVyKFF1aWxsOiBhbnksIGN1c3RvbU1vZHVsZXM6IEN1c3RvbU1vZHVsZVtdIHwgdW5kZWZpbmVkLCBiZWZvcmVSZW5kZXIgPSB0aGlzLmNvbmZpZy5iZWZvcmVSZW5kZXIpIHtcbiAgICAvLyBUaGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBlYWNoIHRpbWUgdGhlIGVkaXRvciBuZWVkcyB0byBiZSByZW5kZXJlZCxcbiAgICAvLyBzbyBpdCBvcGVyYXRlcyBpbmRpdmlkdWFsbHkgcGVyIGNvbXBvbmVudC4gSWYgbm8gY3VzdG9tIG1vZHVsZSBuZWVkcyB0byBiZVxuICAgIC8vIHJlZ2lzdGVyZWQgYW5kIG5vIGBiZWZvcmVSZW5kZXJgIGZ1bmN0aW9uIGlzIHByb3ZpZGVkLCBpdCB3aWxsIGVtaXRcbiAgICAvLyBpbW1lZGlhdGVseSBhbmQgcHJvY2VlZCB3aXRoIHRoZSByZW5kZXJpbmcuXG4gICAgY29uc3Qgc291cmNlcyA9IFt0aGlzLnJlZ2lzdGVyQ3VzdG9tTW9kdWxlcyhRdWlsbCwgY3VzdG9tTW9kdWxlcyldXG4gICAgaWYgKGJlZm9yZVJlbmRlcikge1xuICAgICAgc291cmNlcy5wdXNoKGZyb20oYmVmb3JlUmVuZGVyKCkpKVxuICAgIH1cbiAgICByZXR1cm4gZm9ya0pvaW4oc291cmNlcykucGlwZShtYXAoKCkgPT4gUXVpbGwpKVxuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcml2YXRlIHJlZ2lzdGVyQ3VzdG9tTW9kdWxlcyhcbiAgICBRdWlsbDogYW55LFxuICAgIGN1c3RvbU1vZHVsZXM6IEN1c3RvbU1vZHVsZVtdIHwgdW5kZWZpbmVkLFxuICAgIHN1cHByZXNzR2xvYmFsUmVnaXN0ZXJXYXJuaW5nPzogYm9vbGVhblxuICApIHtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoY3VzdG9tTW9kdWxlcykpIHtcbiAgICAgIHJldHVybiBvZihRdWlsbClcbiAgICB9XG5cbiAgICBjb25zdCBzb3VyY2VzOiBPYnNlcnZhYmxlPHVua25vd24+W10gPSBbXVxuXG4gICAgZm9yIChjb25zdCBjdXN0b21Nb2R1bGUgb2YgY3VzdG9tTW9kdWxlcykge1xuICAgICAgY29uc3QgeyBwYXRoLCBpbXBsZW1lbnRhdGlvbjogbWF5YmVJbXBsZW1lbnRhdGlvbiB9ID0gY3VzdG9tTW9kdWxlXG5cbiAgICAgIC8vIElmIHRoZSBtb2R1bGUgaXMgYWxyZWFkeSByZWdpc3RlcmVkLCBwcm9jZWVkIHRvIHRoZSBuZXh0IG1vZHVsZS4uLlxuICAgICAgaWYgKHRoaXMucmVnaXN0ZXJlZE1vZHVsZXMuaGFzKHBhdGgpKSB7XG4gICAgICAgIGNvbnRpbnVlXG4gICAgICB9XG5cbiAgICAgIHRoaXMucmVnaXN0ZXJlZE1vZHVsZXMuYWRkKHBhdGgpXG5cbiAgICAgIGlmIChpc09ic2VydmFibGUobWF5YmVJbXBsZW1lbnRhdGlvbikpIHtcbiAgICAgICAgLy8gSWYgdGhlIGltcGxlbWVudGF0aW9uIGlzIGFuIG9ic2VydmFibGUsIHdlIHdpbGwgd2FpdCBmb3IgaXQgdG8gbG9hZCBhbmRcbiAgICAgICAgLy8gdGhlbiByZWdpc3RlciBpdCB3aXRoIFF1aWxsLiBUaGUgY2FsbGVyIHdpbGwgd2FpdCB1bnRpbCB0aGUgbW9kdWxlIGlzIHJlZ2lzdGVyZWQuXG4gICAgICAgIHNvdXJjZXMucHVzaChtYXliZUltcGxlbWVudGF0aW9uLnBpcGUoXG4gICAgICAgICAgdGFwKChpbXBsZW1lbnRhdGlvbikgPT4ge1xuICAgICAgICAgICAgUXVpbGwucmVnaXN0ZXIocGF0aCwgaW1wbGVtZW50YXRpb24sIHN1cHByZXNzR2xvYmFsUmVnaXN0ZXJXYXJuaW5nKVxuICAgICAgICAgIH0pXG4gICAgICAgICkpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBRdWlsbC5yZWdpc3RlcihwYXRoLCBtYXliZUltcGxlbWVudGF0aW9uLCBzdXBwcmVzc0dsb2JhbFJlZ2lzdGVyV2FybmluZylcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gc291cmNlcy5sZW5ndGggPiAwID8gZm9ya0pvaW4oc291cmNlcykucGlwZShtYXAoKCkgPT4gUXVpbGwpKSA6IG9mKFF1aWxsKVxuICB9XG59XG4iXX0=